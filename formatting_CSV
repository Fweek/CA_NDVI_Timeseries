import sys,os,csv,datetime,string,numpy

#Set working directory
os.chdir('C:\Users\Michael\Desktop\CSVprep')

#Make a new directory for the output files if it does not already exist
if not os.path.exists('Output'):
    os.makedirs('Output',)

# Loop through every file in the current working directory.
for csvFilename in os.listdir('.'):
    if not csvFilename.endswith('.csv'):
        continue # skip non-csv files

    print('Modifying ' + csvFilename + '...')

    #Open the file
    fPtr = open(csvFilename)
    if fPtr is None:
      print "Error opening %s " % csvFilename
      sys.exit(1)

    #Read in the file using csv
    rdr= csv.reader(fPtr)
    fPtr = None

    #Create container for input
    input = []

    #Keep only columns we want SIMS ID, Date, and NDVI
    for l in rdr:
      input.append((l[2],l[3],l[7]))

    #Remove header
    input = input[1::]
    print input

    #Create temp container
    temp = []

    #Changing date
    for l in input:
        #Grab only date column
        dtStr = l[1]
        #Parse out year, month, day. Ugly code but need to get this moving...
        yr, mm, dd = dtStr[0:4], dtStr[5:7], dtStr[8:10]
        #print yr, mm, dd #Debug
        #Reformat date
        dtNum = (datetime.datetime(int(yr), int(mm), int(dd)) - datetime.datetime(1980, 1, 1)).days
        #print dtNum #Debug

        #Replace {nd=null} with -9999
        ndvi = l[2]
        # print ndvi #Debug
        ndvi2 = string.replace(ndvi, '{nd=null}', '-9999')
        # print ndvi2 #Debug

        temp.append((l[0],dtNum,ndvi2))

    temp.sort()
    print temp

    #Start creating matrix
    #Find how many unique ids do we have?
    simsIds = [i[0] for i in temp]
    print simsIds

    #Get all the unique simsids and count them
    uniqueIds = numpy.unique(simsIds)
    yDim = numpy.count_nonzero(uniqueIds)+1 #add one to account for row header
    print "Number of unique sims ids %d" % yDim

    #Find how many unique dates do we have?
    allDates = [i[1] for i in temp]
    print allDates

    #Get all unique dates and count them
    uniqueDT =  numpy.unique(allDates)
    xDim = numpy.count_nonzero(uniqueDT)+1 #add one to account for column header
    print "Number of unique dates %d" % xDim

    #Create final output array
    finalOutput = numpy.ones((yDim,xDim)) * -9999.0
    print finalOutput

    #Populate the header and the first column with date and SIMs ID respectively
    finalOutput[0,1:xDim] = uniqueDT
    finalOutput[1:yDim,0] = uniqueIds
    print finalOutput

#fucntion that finds index number when provided a date and list
def dateIndex(list, date):
    l=zip(*list)[1]
    print l.index(date)




    for id in uniqueIds: #for each unique ID in the list of SIMs IDs
     for i in temp: #for that each unique ID in the input list
       tempOutId = i[0] #look in the first column which is just SIMs IDs
       if id == tempOutId: #check if the two IDs match
          for d in temp #if they match check the date and add to column
            for n in finalOutput
                tempDate = n[0]
                if d == tempDate


          #Example: output[15,20] = ndvi
       else:
          continue





    #Write list to CSV
    Results = open(os.path.join('Output', csvFilename),"wb")
    wtr= csv.writer(Results)

    for i in finalOutput:
        wtr.writerow(i)



